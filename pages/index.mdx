import { Head } from "../components/Head"
import { App } from "../components/App"

<Head />

# Random Emojis

A live feed of random emojis using Cloudflare, WebSockets and Redux.

<App />

## User Stories

As one of Cadell's friends, I want a live feed of random emojis that I can add to so I can send and receive random emojis for some mild amusement.

As Cadell, I want to build a realtime application using WebSockets and Cloudflare because they're all cool and I haven't used any of them before.

As Cadell, I want to build a stateful application using Cloudflare's Durable Objects so I can decide whether to use it for future applications, like [Very Nested](https://verynested.cadell.dev).

## Background

Cloudflare is pretty hot at the moment. They've announced [R2](https://news.ycombinator.com/item?id=28682237), a cheap alternative to AWS S3 with a smooth migration path, [Cloudflare Pages has gone full stack](https://news.ycombinator.com/item?id=29253032), allowing you to deploy stateful applications with ease, and Durable Objects are the stateful part of that stack and they [sound really interesting](https://blog.cloudflare.com/durable-objects-easy-fast-correct-choose-three/).

I've got a soft spot for stateful applications. I've deployed [PRAwN Stack](https://prawn.cadell.dev) on AWS recently and it was a journey to get there. I've also deployed [lots of frontend applications](https://cadell.dev) on Netlify and they make it really easy. I've also used their serverless functions for [https://verynested.cadell.dev] and it was pretty easy too. But Netlify doesn't offer storage for stateful applications, they recommend using another provider like AWS which isn't as easy. Stateful applications are fun applications. I made my first one 12 years ago in high school, a basic chat room powered by a LAMP stack. Firebase makes stateful applications easy but it comes with it's own tradeoffs. It's going to interesting to see how this space develops with companies like Vercel and Netlify raising lots of money to make the deployment experience smoother.

Cloudflare is already moving in this space with [Cloudflare Pages](https://news.ycombinator.com/item?id=29253032) but they [also support WebSockets](https://blog.cloudflare.com/introducing-websockets-in-workers/) which means we can build realtime applications too. The only thing better than a stateful application is a realtime stateful application, just look at Google Docs and Notion. They've recently [reduced the costs of using WebSockets](https://blog.cloudflare.com/workers-optimization-reduces-your-bill/) which is great! This article on using [Durable Objects in production](https://news.ycombinator.com/item?id=25084470) to build a realtime application was a massive inspiration for this project.

Realtime applications are a thing on their own and there's a range of solutions out there, each with their own tradeoffs. CRDTs are pretty hot right now too, like [SyncedStore](https://news.ycombinator.com/item?id=29483913) which builds on [Yjs](https://github.com/yjs/yjs). Another option is [Automerge](https://news.ycombinator.com/item?id=16309533) which has an API that might play nicer with Redux and here's an article on the [performance and optimisations of CRDT solutions](https://news.ycombinator.com/item?id=28017204). It goes deep. [Figma found CRDTs were overkill](https://news.ycombinator.com/item?id=21378858) for their use case because they had a central server to act as a source of truth whereas CRDTs more for peer to peer communication but they did use them as inspiration.

I decided to do the same. I was already familiar with Redux where there's a separation between actions and how they update a central state using reducers. Actions already have all the information we need to update the state so why can't we share those around using WebSockets? I found [Logux](https://logux.io/) and [@localfirst/state](https://github.com/local-first-web/state) and [some others](https://github.com/markerikson/redux-ecosystem-links/blob/master/store.md#synchronization) but ultimately couldn't see how these would work with Cloudflare, at least at this stage, so I decided against them.

## Solution

![sequence diagram](/sequence.png)
[Sequence Diagram in MermaidJS](https://mermaid.live/edit/#pako:eNrtlD1PwzAQhv_K4YWlDHTM0AlWQEKIJcslftu6JOfiD6qq4r9zIQkFRFvETKbEeZ873yPLO1N7C1MYinjOkBpXjheB21KIc_KS2wpBP_RZc0iudmuWRA8RgS4PrE9L6f_0qYvZ7NGHJ4SCGqTzSLUXQZ0oRycL2qCKvn5Cij3UZxW6yoGrBnRbrTRdUPQtvIA22ihS8ifqfMV_qpd8AKUlxkLOywF03P8SATpAx6D1Kxe1K9U5BEhqtrTkF3wbolfwQXYz0DzLgI-ibnwCBbdYJvJzGpm7hredTtLqCH1b1lb8xe_03-_0D36nn_xGiI3EA3XCLlurUa97DGP-qNaj1K8lqgrB5ii6l7gdjtCEeE-pvUgVIN1eYA-e0z08OP1U4-ydMhPTIrTsrF4cu26pNDpYi9IU-mox59yk0pTyqtG8tpxwbZ1OYoo5NxET090t91upTZFCxhga7p4h9foGWI6T6Q)

## Notes

This was a fun project overall. There were certainly rough parts but now that it's all working I'm really happy with how it turned out. Sharing Redux actions over WebSockets works well and the code for the the Durable Objects looks great.

Glen Maddern describes Durable Objects as Stateful Workers in [Durable Objects in production](https://news.ycombinator.com/item?id=25084470) and after working with them I have to agree. Durable Objects work just like workers with some persistence methods added on top.

Cloudflare Pages was a bit of an issue 

[ up to here ]

## Challenges

- My first Cloudflare Pages deploy failed with NextJS, needed to specify a node version with nvmrc.
- WebSockets documentation is focused on workers not pages so I have to workout how that works.
- I can't find the error logs for functions deployed with pages so I have to guess, deploy, check and refine.
- using durable objects with pages is really challenging
- cloudflare pages wasn't building anything on the 13th of Jan, failing with an internal error so I couldn't test my durable object binding
- cloudflare doesn't always take you to the right build when you click view build
- again, lack of logs means time spent into put into more manual logging, particularly with websockets when talking to a durable object for the first time
- publishing my first package was really hard without tsup

## Milestones

- ✅ setup cloudflare account
- ✅ deploy nextjs website
- ✅ setup redux on the frontend
- ✅ create first function
- ✅ connect to workers over websocket, 2.5h to get to this point
- ✅ deploy a durable object, 2h
    - create a durable object
        - resources
            - https://blog.cloudflare.com/building-full-stack-with-pages/
            - https://github.com/cloudflare/images.pages.dev
            - https://developers.cloudflare.com/pages/platform/functions#durable-object-namespace
            - https://developers.cloudflare.com/workers/learning/using-durable-objects#uploading-a-durable-object-worker
        - I thought you could just put a file in the durable_objects folder but that doesn't appear to be the case
            - https://github.com/cloudflare/images.pages.dev/tree/main/durable_objects
            - here's a ts template
                - https://github.com/cloudflare/durable-objects-typescript-rollup-esm
            - doesn't work by itself, you have to publish inside the folder
                - requires npx wrangler login, which isn't mentioned
                - npm run publish then goes on to produce a strange error about agreements which I interpreted as durable objects not being supported in the free tier
                    - Workers > Plan > Paid to set that up
            - npx run publish then goes onto produce the same error but this time it actually shows a prompt where you can agree
                - I think this was meant to come up before, probably a bug
            - finally npx run publish works and now I understand it better - it creates a durable object that you can manually bind in pages to access it. that sure was confusing
        - next steps
            - use ts template
            - bind the namespace
            - use the durable object from a pages worker
            - raise this shit experience with cloudflare 
                - PR to the demo readme to correct that
                - correct the blog article which is misleading
- ✅ access the durable object from a worker, 1.5h
    - builds failed due to an internal error which was annoying
    - needed to add more error logging because again I can't see builds
- ✅ setup durable worker for messages, 2h
    - similar to a single chat room
        - we'll add sessions later
    - setup websockets
        - https://github.com/cloudflare/workers-chat-demo/blob/master/src/chat.mjs
    - broadcast messages to all connected clients
    - send previously sent messages back to client on first connection
- ✅ send random emojis instead of "Tik" - 1h
    - maybe setup a chat-style window with css too
- ✅ setup typescript - 1h
    - https://github.com/cloudflare/durable-objects-typescript-rollup-esm
- ✅ create package for my styles and components - 3h
    - ended up using tsup
    - had to make mdx-js/react the peer dependency
- ✅ style the site and add mdx - 1.5h
- add project description