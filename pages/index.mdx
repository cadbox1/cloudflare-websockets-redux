import { Head } from "../components/Head"
import { App } from "../components/App"

<Head />

# Random Emojis

A live feed of random emojis using Cloudflare, WebSockets and Redux.

<App />

## User Stories

As one of Cadell's friends, I want a live feed of random emojis that I can add to so I can send and receive random emojis for some mild amusement.

As Cadell, I want to build a realtime application using WebSockets and Cloudflare because they're cool and I haven't used them before.

As Cadell, I want to build a stateful application using Cloudflare's Durable Objects so I can decide whether to use it for future applications, like [Very Nested](https://verynested.cadell.dev).

## Background

Cloudflare is pretty hot at the moment. They've announced [R2](https://news.ycombinator.com/item?id=28682237), a cheap alternative to AWS S3 with a smooth migration path, making it a serious competitor, [Cloudflare Pages has gone full stack](https://news.ycombinator.com/item?id=29253032) allowing you to deploy fullstack applications with ease and Durable Objects is a new kind of data store that [sounds really interesting](https://blog.cloudflare.com/durable-objects-easy-fast-correct-choose-three/).

I've got a soft spot for stateful applications. Stateful applications are applications store data in the cloud and that can be really fun because it allows people to interacts with each other. I made a chat app 12 years ago in high school using a LAMP stack on free hosting and it was fun! The free hosting then went on to get hacked, leaking my severely used password to the world. More fun!

I recently deployed a stateful application, [PRAwN Stack](https://prawn.cadell.dev), to AWS and I'm really happy with the result but deploying to AWS was a journey to say the least. I think I've been spoilt by products like [Netlify](https://www.netlify.com/) that make deploying apps easy to the point where it's actually fun. I've used it for multiple [frontend applications](https://cadell.dev) and a few backend functions but nothing stateful because they don't have have their own data store. They recommend using another provider like AWS for that which largely defeats the purpose of using Netlify in my opinion. I can use [PRAwN Stack](https://prawn.cadell.dev) for stateful applications using AWS going forward but what are the options? Firebase springs to mind but comes with it's own trade-offs and I don't really know of any others. Vercel and Netlify have raised a lot of money recently, maybe they'll move into this space?

[Cloudflare Pages going fullstack](https://news.ycombinator.com/item?id=29253032) means Cloudflare already is. This is particularly exciting because, as discussed earlier, Cloudflare is pretty hot at the moment! They already have a powerful CDN for static assets, Workers for backend functions and Durable Objects for a data store. If they can tie that all together with a nice developer experience that's half as good as Netlify then that's going to be massive. All board the hype train! 

It doesn't stop there. [Cloudflare also support WebSockets](https://blog.cloudflare.com/introducing-websockets-in-workers/) allowing us to build realtime applications and the only thing better than a stateful application is a realtime stateful application. Just look at Google Docs and Notion. We can use WebSockets, Workers and Durable Objects together to create stateful applications that update live, in realtime. Glenn Maddern has an excellent article on their experience, [Durable Objects in production](https://news.ycombinator.com/item?id=25084470), and it was an inspiration for this project and write-up.

Diving in deeper, realtime applications are a thing all on their own. There's a range of solutions out there, each with their own trade-offs. CRDTs are pretty hot right now. I just read about [SyncedStore](https://news.ycombinator.com/item?id=29483913) which uses [Yjs](https://github.com/yjs/yjs), then there's [Automerge](https://news.ycombinator.com/item?id=16309533) which might work better with Redux and then there's this fun article on the [performance and optimisations of CRDT solutions](https://news.ycombinator.com/item?id=28017204). It goes deep. [Figma found CRDTs were overkill](https://news.ycombinator.com/item?id=21378858) for their use case because they had a central data store to act as a source of truth. They found CRDTs were better suited for peer to peer communication but used used as inspiration in their solution.

I decided to do the same. I have a central data store to act as the source of truth and I'm already familiar with Redux which seems perfect for realtime applications. In Redux, users trigger Actions that are then handled by Reducers to update a central data store. Actions already contain all the information required for the Reducer to update the data store so can't we just send them around to build a realtime application? I found [Logux](https://logux.io/), [@localfirst/state](https://github.com/local-first-web/state) and [some others](https://github.com/markerikson/redux-ecosystem-links/blob/master/store.md#synchronization) that seem to have a similar idea but I couldn't see how they would work with Cloudflare so I decided to roll my own.

## Solution

![sequence diagram](/sequence.png)
[Sequence Diagram in MermaidJS](https://mermaid.live/edit/#pako:eNrtlD1PwzAQhv_K4YWlDHTM0AlWQEKIJcslftu6JOfiD6qq4r9zIQkFRFvETKbEeZ873yPLO1N7C1MYinjOkBpXjheB21KIc_KS2wpBP_RZc0iudmuWRA8RgS4PrE9L6f_0qYvZ7NGHJ4SCGqTzSLUXQZ0oRycL2qCKvn5Cij3UZxW6yoGrBnRbrTRdUPQtvIA22ihS8ifqfMV_qpd8AKUlxkLOywF03P8SATpAx6D1Kxe1K9U5BEhqtrTkF3wbolfwQXYz0DzLgI-ibnwCBbdYJvJzGpm7hredTtLqCH1b1lb8xe_03-_0D36nn_xGiI3EA3XCLlurUa97DGP-qNaj1K8lqgrB5ii6l7gdjtCEeE-pvUgVIN1eYA-e0z08OP1U4-ydMhPTIrTsrF4cu26pNDpYi9IU-mox59yk0pTyqtG8tpxwbZ1OYoo5NxET090t91upTZFCxhga7p4h9foGWI6T6Q)

After all the background reading, the solution is quite simple. The frontend is a NextJS app with Redux, the API is a Cloudflare Worker and the data store is a Cloudflare Durable Object. The frontend sets up a WebSocket connection with the Worker which then acts as a proxy for the Durable Object. When the connection is first established the Durable Object will send down the current feed of Emojis and remembers the connection for syncing updates later on.

One interesting thing to note is the connection is stored in the Durable Object's memory instead of it's persisted storage. We can do this because Durable Objects are alive (and billed) for the entire duration of a WebSocket connection. That's why Glenn Maddern thinks about them more as Stateful Workers than Durable Objects and I have to agree. More on this later.

 Clicking the Add Emoji button creates a new Redux Action which a Reducer then handles to update the local data store which updates the page to display the new emoji using React. Nothing groundbreaking here but here's the fun part. The Action is also sent through a WebSocket connection to the Durable Object. The Durable Object then broadcasts the Action to other connected users through their WebSocket connections and also stores the emoji in the persisted feed for users that join later on. The Actions from other users are handled by Redux in the same way local actions are. A Reducer updates the local store and the page is updated to display the new emoji.

This is deployed using Cloudflare Pages which builds gives us a build and deploy pipeline for each commit we make. This is the same nice developer experience that Netlify provides but I later learned Durable Objects need to be deployed separately and manually. More on that later.

And that's it! That's how I built a fun, realtime, stateful application with Cloudflare.

[ up to here ]

## Implementation

This was a fun project overall. There were certainly rough parts but now that it's all working I'm really happy with how it's all turned out. Sharing Redux actions over WebSockets works well and the [Durable Object code](https://github.com/cadbox1/random-emojis/blob/main/durable_objects/src/document.ts) looks great.

Glen Maddern describes Durable Objects as Stateful Workers in [Durable Objects in production](https://news.ycombinator.com/item?id=25084470) and I have to agree now that I've worked with them. Durable Objects work just like workers with some persistence methods added on top. This is particularly evident with WebSockets because the Durable Object is kept alive for the entire duration of the connection so we actually store the connection in memory rather the persisting it. I don't think there's much of a distinction between the two options in the docs, maybe because it's only relevant when using WebSockets.

I've built NextJS apps with MDX and custom components [before](https://github.com/cadbox1/prawn-stack) and decided to split them out into a reusable package for this project. The result is [cadells-vanilla-components](https://github.com/cadbox1/cadells-vanilla-components) and it's used in this [NextJS template](https://github.com/cadbox1/cadells-nextjs-template) I built to go with it. Creating the package was a bit harder than I first thought, and it wasn't critical for this project, but I'm really happy with the result and my next NextJS app should be much easy to setup. I originally tried using [tsdx](https://github.com/jaredpalmer/tsdx) but the typescript types weren't correct and I couldn't work out why. I started looking for a tool that used [esbuild](https://github.com/evanw/esbuild) instead of [Rollup](https://github.com/rollup/rollup) and found [tsup](https://github.com/egoist/tsup) which pretty much worked out of the box. Happy days! Tsdx did introduce me to [np](https://github.com/sindresorhus/np) for publishing to NPM so I brought that over and it works really well. Everything happened for a reason.

## Challenges

My biggest challenge in this project was Cloudflare Pages. As discussed earlier, I chose to use Cloudflare Pages because it sounded like a nice developer experience - just push your code and the build and deployment is handled for you. It goes further than Netlify by offering not only backend functions but also persistence with Durable Objects. They just announced [Cloudflare Pages Goes Full Stack](https://blog.cloudflare.com/cloudflare-pages-goes-full-stack) and I was keen to ride the hype train.

However, new products and hype trains are often a bit rough around the edges and that was certainly my experience with Cloudflare Pages. I'm extremely happy with the result but it was a bit of a journey to get there. In short:

1. No Function logs.
1. Functions API is slightly different to Workers API.
1. Durable Objects usage isn't well documented.
1. My very first NextJS build failed.
1. Long feedback cycles with each build taking a few minutes.
1. Clicking on an in-progress build doesn't always take you to that build.
1. There was some downtime one day where all builds failed.

None of these were deal breakers but they did subtract from the developer experience. Thankfully, a lot of these should easy to fix.

### No Function Logs
There's no logs for your Functions. Or at least I couldn't find where they are or any documentation about them. This made it very hard to work out what was going wrong and I had to capture each error and send it back in a HTTP response or through the WebSocket, when I eventually worked out how to set that up. This made for long feedback cycles especially when each builds take a few minutes and you're only deploying some code to capture the error. Workers have logs so I suspect it's on the way.

### Functions API
The Functions API is slightly different to the Workers API meaning you have to unravel every Workers example you come across. Now that I'm finished, the differences aren't massive but it definitely adds some overhead when you're getting started, particularly with WebSockets. This is amplified by the lack of Function logs and long feedback cycles discussed above.

### Poor Durable Objects Documentation
Using Durable Objects with Pages is really poorly documented. This is particularly frustrating because Pages support for Durable Objects was a big driver for the project. TL;DR Durable Objects are deployed separately and manually and I've documented the [process here](https://github.com/cadbox1/random-emojis/tree/main/durable_objects).

This blog post on [Building full stack with Pages](https://blog.cloudflare.com/building-full-stack-with-pages#persisting-data) has a code example for Durable Objects that shows a single javascript file at `./durable_objects/downloadCounter.js`. This looked fantastic to me. Just like Functions are automatically deployed from a `functions` folder, Durable Objects are deployed from a `durable_objects` folder. That's not the case because I tried and it didn't work. I think the blog post is a bit misleading and should be updated.

![durable objects usage on their blog](/durable-objects-usage-on-blog.png)

Diving into why, I checked out the [images.pages.dev code example](https://github.com/cloudflare/images.pages.dev) for the blog post. That's where I found an entire package in the [durable_objects folder](https://github.com/cloudflare/images.pages.dev/tree/main/durable_objects) instead of a single javascript file. The README then explains that this is because wrangler v2 doesn't support Durable Objects. I don't know what wrangler is or how it's related to Pages. Adding the package doesn't deploy a Durable Object and that's when I found out you have to deploy the Durable Object manually.

Googling `pages durable objects` takes you to a [page that sounds relevant](https://developers.cloudflare.com/workers/learning/using-durable-objects/) but it's actually for Workers, not Pages. These are the [Pages Docs for Durable Objects](https://developers.cloudflare.com/pages/platform/functions/#durable-object-namespace) and they don't reveal much but it does confirm we need to deploy our Durable Object manually

Let's do that by jumping back to the README.

```
npm install;
CF_ACCOUNT_ID="<YOUR CLOUDFLARE ACCOUNT ID>" npm run publish;
```

That doesn't work and I'll quickly go through why:
1. That command doesn't use the wrangler installed as a dependency so it will fail unless you have wrangler installed globally.
1. You need to login to Cloudflare with wrangler first.
1. Deployment will then fail with an error message that loosely mentions your plan and takes you to a blank page in the dashboard. I think this is a bug but you can get around it by signing up to the Workers Paid plan from the dashboard.
1. Your next deploy will fail because you need to agree to some terms. Thankfully, this link works.
1. You need to bind your Durable Object as an environment variable in Pages to use it.

I've documented the actual process in my [Durable Object package](https://github.com/cadbox1/random-emojis/tree/main/durable_objects) but it's basically:
1. Sign up for the Workers Paid plan.
1. Login to Wrangler
1. Try and deploy the Durable Object then accept the license agreement when prompted.
1. Actually deploy the Durable Object.
1. Go into Cloudflare Pages in the Cloudflare Dashboard and bind the newly deployed Durable Object to an environment variable.

So deploys are manual and it was a bit of a journey to get here but the positive is deploys are really fast. It's closer to seconds than minutes and faster than some local environments I've used. I probably wouldn't need a local environment at all when it's this fast and the feedback cycles were much shorter and nicer than Pages. Makes me think I shouldn't have used Pages but more on that later.

### First NextJS Build Failed
The first time you build a stock NextJS app in Cloudflare Pages it will fail. This is a really small issue and it's easy to fix but it hurts the developer experience, particularly when Netlify does so well in this area. It's because the [default Node version in Pages is too old for NextJS 12](https://community.cloudflare.com/t/pages-node-js-version-is-too-old-for-nextjs-12/335044) and the solution I went with was to include a [.nvmrc](https://github.com/cadbox1/random-emojis/blob/main/.nvmrc) in the project to specify a Node version that is compatible with NextJS 12. I think setting up something to specify the node version is best practice anyway but new developers aren't going to know that and they are going to run into this.

### Builds, Bugs and Downtime

This isn't isolated to Cloudflare Pages but each build does take a few minutes, increasing the feedback cycle. To make things worse, there seems to be a bug with the builds page where clicking a build doesn't always take you to that build. It might have something to do with in-progress builds but I just ended up refreshing the builds page each time which seemed to make the links work. This makes for a poor experience when most of your builds are adding some sort of logging just to work out what went wrong because, as discussed above, there's no error logs.

I eventually became content with this and added it to my "modern development is funny sometimes" list. Then I deployed my Durable Object with Wrangler and saw how fast that was and all my contentment was instantly erased. "What if we could have cloud AND fast feedback cycles!?". More on this below. If you like this idea then you might like this article I found the other day about a [A magical AWS serverless developer experience](https://news.ycombinator.com/item?id=30827038) which uses [Serverless Stack (SST)](https://serverless-stack.com/).

Pages have since announced [fast builds](https://community.cloudflare.com/t/cloudflare-pages-fast-builds-open-beta/359897) which sounds promising.

The only other thing that's barely worth mentioning is Pages had some downtime for all my builds one day. Downtime happens, particularly in betas, but I don't get a lot of time for side projects like these and it was disappointing to be blocked after working up the motivation to work on this project one day. Maybe local development is important? I tend to think so but [others aren't so sure](https://dev.to/garethmcc/why-local-development-for-serverless-is-an-anti-pattern-1d9b).

### Possible Solution: Use Wrangler Instead of Pages
You could make the case that it would be better to use Wrangler over Pages because:
1. There's more documentation for things like WebSockets and Durable Objects.
1. You'll have logs for your Workers.
1. Deploys are faster.
1. You'll have to deploy Durable Objects with Wrangler anyway.

On the other hand:
1. Pages sounds like the long term vision for Cloudflare.
1. A team would probably need a build pipeline.
1. Pages documentation will get better.
1. Surely they'll have Function logs soon.
1. Durable Objects deployment might get better.
1. Builds will get faster, they've already announced [fast builds](https://community.cloudflare.com/t/cloudflare-pages-fast-builds-open-beta/359897).

## Summary

This was awesome. I'm really happy with the app, code and Cloudflare and I'm even more proud because of the challenges I overcame. On the other hand, if I waited a few months and let them polish up the beta then maybe I wouldn't have so many challenges but then I would miss the hype train! Anyway, I hope Cloudflare can improve the developer experience based on my feedback and create a better product in an exciting space. It probably took longer to write about than it did to actually develop the app but I'm working on that too!

## Milestones

- ✅ Setup Cloudflare account.
- ✅ Deploy NextJS website.
- ✅ Setup Redux.
- ✅ Create my first Worker function.
- ✅ Setup a WebSocket connection with a Worker. (2.5h to get to this point)
- ✅ Deploy a Durable Object. (2h)
    - resources
        - https://blog.cloudflare.com/building-full-stack-with-pages/
        - https://github.com/cloudflare/images.pages.dev
        - https://developers.cloudflare.com/pages/platform/functions#durable-object-namespace
        - https://developers.cloudflare.com/workers/learning/using-durable-objects#uploading-a-durable-object-worker
    - challenges
        - it was really hard to workout how to setup a Durable Object.
- ✅ Access the Durable Object from a Worker. (1.5h)
    - builds failed due to an internal error which was annoying
    - needed to add more error logging because again I can't see builds
- ✅ Setup a Durable Worker for messages. (2h)
    - https://github.com/cloudflare/workers-chat-demo/blob/master/src/chat.mjs
- ✅ Send random emojis instead of a "Tik" message. (1h)
- ✅ Setup Typescript for the Durable Object - 1h
    - https://github.com/cloudflare/durable-objects-typescript-rollup-esm
- ✅ Create a reusable npm package for components and styles. (3h)
    - https://github.com/cadbox1/cadells-vanilla-components
- ✅ Style this and setup MDX. (1.5h)
- Write about the project and my experience (20h, massive guess).